# Database Schema Documentation

## Overview

The Bantu Project uses a PostgreSQL database managed through Supabase. The schema is designed to support language preservation efforts, including audio recordings, transcriptions, translations, and user contributions.

## Schema Diagram

```
┌─────────────┐       ┌──────────────────┐       ┌───────────────┐
│   profiles  │       │ audio_recordings  │       │ transcriptions│
├─────────────┤       ├──────────────────┤       ├───────────────┤
│ id          │       │ id               │       │ id            │
│ full_name   │       │ user_id          │◄──────┤ recording_id  │
│ country     │       │ dialect_id       │       │ user_id       │
│ native_lang │◄──────┤ storage_path     │       │ text          │
│ pref_dialect│       │ duration_seconds │       │ is_asr_gen    │
│ contrib_cnt │       │ status           │       │ confidence    │
│ created_at  │       │ is_gen_prompt    │       │ review_status │
│ updated_at  │       │ prompt_text      │       │ reviewed_by   │
└─────────────┘       │ created_at       │       │ created_at    │
                      │ updated_at       │       │ updated_at    │
                      └──────────────────┘       └───────┬───────┘
                                                         │
┌─────────────┐       ┌──────────────────┐       ┌───────▼───────┐
│   dialects  │       │  service_logs    │       │  translations │
├─────────────┤       ├──────────────────┤       ├───────────────┤
│ id          │◄──────┤ id               │       │ id            │
│ name        │       │ service_name     │       │ transcript_id │
│ code        │       │ event_type       │       │ user_id       │
│ description │       │ status           │       │ text          │
│ created_at  │       │ metadata         │       │ target_lang   │
│ updated_at  │       │ created_at       │       │ is_machine_gen│
└─────────────┘       └──────────────────┘       │ confidence    │
                                                 │ review_status │
                                                 │ reviewed_by   │
                                                 │ created_at    │
                                                 │ updated_at    │
                                                 └───────────────┘
```

## Tables

### profiles

Stores user profile information.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key, references auth.users |
| full_name | text | User's full name |
| country | text | User's country |
| native_language | uuid | References dialects.id |
| preferred_dialects | uuid[] | Array of dialect IDs |
| contribution_count | integer | Number of contributions |
| created_at | timestamptz | Creation timestamp |
| updated_at | timestamptz | Last update timestamp |

### dialects

Stores information about language dialects.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| name | text | Dialect name (e.g., "Yoruba") |
| code | text | Dialect code (e.g., "yor") |
| description | text | Description of the dialect |
| created_at | timestamptz | Creation timestamp |
| updated_at | timestamptz | Last update timestamp |

### audio_recordings

Stores audio recording metadata.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | References auth.users |
| dialect_id | uuid | References dialects.id |
| storage_path | text | Path to audio file in storage |
| duration_seconds | integer | Duration in seconds |
| status | contribution_status | Status enum ('pending', 'processing', 'completed', 'error') |
| is_generated_prompt | boolean | Whether prompt was generated |
| prompt_text | text | Text prompt for recording |
| processing_service | text | Service processing the recording |
| processing_started_at | timestamptz | Processing start timestamp |
| processing_completed_at | timestamptz | Processing completion timestamp |
| created_at | timestamptz | Creation timestamp |
| updated_at | timestamptz | Last update timestamp |

### transcriptions

Stores transcriptions of audio recordings.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| recording_id | uuid | References audio_recordings.id |
| user_id | uuid | References auth.users |
| text | text | Transcription text |
| is_asr_generated | boolean | Whether generated by ASR |
| confidence_score | float | Confidence score (0-1) |
| review_status | review_status | Status enum ('pending', 'approved', 'rejected') |
| reviewed_by | uuid | References auth.users |
| service_version | text | ASR service version |
| model_id | text | ASR model identifier |
| processing_metadata | jsonb | Additional processing metadata |
| created_at | timestamptz | Creation timestamp |
| updated_at | timestamptz | Last update timestamp |

### translations

Stores translations of transcriptions.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| transcription_id | uuid | References transcriptions.id |
| user_id | uuid | References auth.users |
| text | text | Translated text |
| target_language | text | Target language code |
| is_machine_generated | boolean | Whether machine-generated |
| confidence_score | float | Confidence score (0-1) |
| review_status | review_status | Status enum ('pending', 'approved', 'rejected') |
| reviewed_by | uuid | References auth.users |
| service_version | text | Translation service version |
| model_id | text | Translation model identifier |
| processing_metadata | jsonb | Additional processing metadata |
| created_at | timestamptz | Creation timestamp |
| updated_at | timestamptz | Last update timestamp |

### service_logs

Stores logs from microservices.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| service_name | text | Name of the service |
| event_type | text | Type of event |
| status | text | Status of the event |
| metadata | jsonb | Additional metadata |
| created_at | timestamptz | Creation timestamp |

### model_registry

Stores information about ML models.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| model_type | text | Type of model ('asr' or 'translation') |
| version | text | Model version |
| dialect_id | uuid | References dialects.id |
| storage_path | text | Path to model in storage |
| metrics | jsonb | Model performance metrics |
| is_active | boolean | Whether model is active |
| created_at | timestamptz | Creation timestamp |
| updated_at | timestamptz | Last update timestamp |

## Enums

- **contribution_status**: 'pending', 'processing', 'completed', 'error'
- **contribution_type**: 'recording', 'transcription', 'translation'
- **review_status**: 'pending', 'approved', 'rejected'

## Row Level Security (RLS)

The database implements Row Level Security to control access to data:

### Dialects

- **Public read access**: Anyone can view dialects

### Profiles

- **User-specific access**: Users can only view and update their own profiles

### Audio Recordings

- **User-specific access**: Users can only view and create their own recordings
- **Service role access**: Services can view all recordings

### Transcriptions and Translations

- **Public read access**: Authenticated users can view all transcriptions/translations
- **User-specific update access**: Users can only update their own contributions
- **Service role access**: Services can manage all transcriptions/translations

## Functions and Triggers

### handle_new_user()

Automatically creates a profile when a new user is created.

```sql
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.profiles (id, full_name)
  VALUES (new.id, new.raw_user_meta_data->>'full_name');
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION handle_new_user();
```

## Indexes

The following indexes improve query performance:

- Primary keys on all tables
- Foreign key indexes
- Indexes on frequently queried columns (status, review_status)

## Migrations

Database schema changes are managed through migration files in the `supabase/migrations` directory:

- `20250210154829_spring_swamp.sql`: Initial schema creation
- `20250215161653_morning_math.sql`: Enhanced schema with additional fields

## Best Practices

- Use prepared statements to prevent SQL injection
- Implement Row Level Security for all tables
- Use foreign key constraints to maintain data integrity
- Include created_at and updated_at timestamps on all tables
- Use enums for status fields to ensure data consistency